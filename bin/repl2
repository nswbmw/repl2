#!/usr/bin/env node
'use strict';

var fs = require('fs');
var path = require('path');
var repl = require('repl');

var _ = require('lodash');
var home = require('home')();
var globalPath = require('global-modules');
var cwd = process.cwd();

var noderc = {};
try {
  _.assign(noderc, JSON.parse(fs.readFileSync(path.join(home, '.noderc'), 'utf-8')));
} catch(e) {}
try {
  _.assign(noderc, JSON.parse(fs.readFileSync(path.join(cwd, '.noderc'), 'utf-8')));
} catch(e) {}

var modules = {};
_.each(noderc, function (value, key) {
  var moduleInfo = tryRequire(key);
  if (moduleInfo) {
    modules[value] = moduleInfo.module;
    console.log('%s = %s@%s', value, key, moduleInfo.version);
  }
});

_.assign(repl.start('> ').context, modules);

function tryRequire (name) {
  var modulePath, _module, version;
  try {
    modulePath = path.join(cwd, 'node_modules', name);
    _module = require(modulePath);
    version = require(modulePath + '/package.json').version;
  } catch(e) {}

  try {
    modulePath = path.join(path.join(globalPath, name));
    _module = require(modulePath);
    version = require(modulePath + '/package.json').version;
  } catch(e) {}

  if (_module && version) {
    return {
      module: _module,
      version: version
    };
  }
}